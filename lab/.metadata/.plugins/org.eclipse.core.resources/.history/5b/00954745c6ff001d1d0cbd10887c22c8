<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.sql.*"%>
<!DOCTYPE html>
<html>
<head>
<link href="style.css" rel="stylesheet" type="text/css">
<meta charset="UTF-8">
<title>수강신청 학생 조회</title>
</head>
<body>
	<%@ include file="user.jsp"%>
	<%@ include file="top_prof.jsp"%>
	<br>
	<br>
	<br>
	<%
		Connection myConn = null;
		Statement stmt = null;
		ResultSet rs = null;
		String mySQL = "";
		PreparedStatement pstmt = null;
		int nTotalStudent = 0;
		String dburl = "jdbc:oracle:thin:@localhost:1521:xe";
		String user = "leebk";
		String passwd = "1124";
		String dbdriver = "oracle.jdbc.driver.OracleDriver"; 
		
		try {
			Class.forName(dbdriver);
			myConn = DriverManager.getConnection(dburl, user, passwd);
			myConn.setAutoCommit(false);
			stmt = myConn.createStatement();
			pstmt = myConn.prepareStatement(
					"select e.c_id, e.c_id_no, s.s_id, s.s_name, s.s_major, t.t_max from enroll e, student s, teach t, course c where t.p_id='" 
					+ session_id + "' and e.c_id = t.c_id and e.c_id_no = t.c_id_no and e.c_id = c.c_id and e.c_id_no = c.c_id_no" 
					+ "and e.s_id = s.s_id and e.year = ? and e.semester = ?");
			
			CallableStatement cstmt = myConn.prepareCall("{? = call Date2EnrollYear(SYSDATE)}");
			cstmt.registerOutParameter(1, java.sql.Types.INTEGER);
			cstmt.execute();
			int nYear = cstmt.getInt(1);
			
			CallableStatement cstmt2 = myConn.prepareCall("{? = call Date2EnrollSemester(SYSDATE)}");
			cstmt2.registerOutParameter(1, java.sql.Types.INTEGER);
			cstmt2.execute();
			int nSemester = cstmt2.getInt(1);
			%>
			<%-- <script>document.getElementById('semesterInfo').innerHTML = "<%=nYear%>년  <%=nSemester%>학기";</script> --%>
<%
		} catch (SQLException ex) {
			System.err.println("SQLException: " + ex.getMessage());
		} catch (ClassNotFoundException ex) {
			System.err.println("ClassNotFoundException: " + ex.getMessage());
		} 
		
		
		
		CallableStatement cstmt = myConn.prepareCall("{? = call Date2EnrollYear(SYSDATE)}");
		cstmt.registerOutParameter(1, java.sql.Types.INTEGER);
		CallableStatement cstmt2 = myConn.prepareCall("{? = call Date2EnrollSemester(SYSDATE)}");
		cstmt2.registerOutParameter(1, java.sql.Types.INTEGER);
		
		try {
			cstmt.execute();
			cstmt2.execute();
			int nYear = cstmt.getInt(1);
			int nSemester = cstmt2.getInt(1);
			System.out.println(nYear);
			%>
			<script>document.getElementById('semesterInfo').innerHTML = "<%=nYear%>년  <%=nSemester%>학기";</script>
		<%
	   }catch(SQLException e){
	      System.err.println("SQLException: " + e.getMessage());
	   }finally{
	      if(cstmt != null)
	         try{myConn.commit(); cstmt.close();
	         }catch(SQLException e){System.err.println("SQLException: " + e.getMessage());}
	   }
		
		%>
	
	<!-- 년도, 학기 추가하기 -->
	<!-- 과목번호로 sort해서 출력하기 -->
	
	
	<div>
	 <input type="text"  id = "semesterInfo"></input>
	</div>
	
	<br>
	<br>
	
	<table width="70%" align="center" border>
		<br>
		<tr>
			<th>과목번호</th>
			<th>분반</th>
			<th>과목명</th>
			<th>학번</th>
			<th>이름</th>
			<th>전공</th>
			<th>최대인원</th>
		</tr>
		

 	<%
	
 	mySQL = "select e.c_id, e.c_id_no, c.c_name, s.s_id, s.s_name, s.s_major, e.t_max from enroll e, course c, student s, teach t where t.p_id='"
			+ session_id
			+ "' and e.c_id = c.c_id and e.c_id_no = c.c_id_no and t.c_id = c.c_id and t.c_id_no = c.c_id_no and e_semester = 1";
	/* pstmt = myConn.prepareStatement(mySQL);
	pstmt.setInt(1, nSemester); */
	rs = pstmt.executeQuery(); 
	
	while (rs.next()) {
		String cid = rs.getString("c_id");
		Integer cidno = rs.getInt("c_id_no");
		String cname = rs.getString("c_name");
		String sid = rs.getString("s_id");
		String sname = rs.getString("s_name");
		String smajor = rs.getString("s_major");
		Integer tmax = rs.getInt("t_max");
		%> 

		<tr>
			<td><%= cid %></td>
			<td><%= cidno %></td>
			<td><%= cname %></td>
			<td><%= sid %></td>
			<td><%= sname %></td>
			<td><%= smajor %></td>
			<td><%= tmax %></td>
		</tr>
	<%
	}
	%>
</table>
</body>
</html>